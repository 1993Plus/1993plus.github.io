---
title: LVS 负载均衡模型
date: 2017-10-27 22:44:31
category: LVS
tags:
	- LVS
	- load balancing
---



**LVS 集群 IP 负载均衡技术**



**通过 NAT 实现虚拟服务器（VS/NAT）**

由于 IPV4 中 IP 地址空间的日益紧张和安全方面的原因，很多网络使用保留 IP 地址（10.0.0.0/255.0.0.0、172.16.0.0.0/255.128.0.0、192.168.0.0/255.255.0.0）。这些地址不在 Internet 上使用，而是专门为内部网络预留的。当内部网络中的主机要访问 Internet 或被 Internet 访问时，就需要采用网络地址转换（Network Address Translation，简称 NAT），将内部地址转化为 Internet 上可用的外部地址。NAT 的工作原理是报文头（目标地址、原地址和端口等）被正确改写后，客户端觉得它们连接的一个 IP 地址，而不同 IP 地址的服务器组也被认为它们是与客户端直接相连的。由此，可以用 NAT 方法将不同 IP 地址的并行网络服务变成在一个 IP 地址上的虚拟服务。

在一组服务器前有一个调度器，它们是通过 Switch/HUB 相连接的。这些服务器提供相同的网络服务、相同的内容，即不管请求被发送到哪一台服务器，执行结果都是一样的。服务的内容可以复制到每台服务器的本地硬盘上。



![VS/NAT](http://ov2iiuul1.bkt.clouddn.com/vs-nat.jpg)





客户端通过 Virtual IP Address（虚拟服务器的 IP 地址）访问网络服务时，请求报文到达调度器，调度器根据连接调度算法从一组正式服务器中选出一台服务器，将报文的目标地址  Virtual IP Address 改写成选定的服务器地址，报文的目标端口改成选定的服务器的相应端口，最后将修改后的报文发送给选出的服务器。同时，调度器在 Hash 表中记录这个链接，当这个链接的下一个报文到达时，从连接 Hash 表中可以得到原选定服务器的地址和端口，进行同样的改写操作，并将报文传给原选定的服务器。当来自真实服务器的响应报文经过调度器时，调度器将报文的源地址和源端口该为 Virtual IP Address 和相应的端口，再把报文发给客户端。在连接上还引入了一个状态机，不同的报文会使得连接处于不同的状态，不同的状态有不同的超时值。在 TCP 连接中，根据标准的  TCP 有限状态机进行状态迁移。在 UDP 中只有一个 UDP 状态，不同状态的超时值是可以设置的，在缺省情况下， SYN 状态的超时为 1 分钟，ESTABLISHED 状态的超时为 15 分钟，FIN 状态的超时为 1 分钟；UDP 状态的超时为 5 分钟。当连接终止或超时，调度器将这个连接中连接 Hash 表中删除。

这样，客户端看到的只是在 Virtual IP Address 上提供的服务，而服务器集群的结构对用户是透明的。对改写后的报文，应用增量调整 Checksum 的算法调整 TCP Checksum 的值，避免了扫描整个报文来计算  Checksum 的开销。

在一些网络服务中，它们将 IP 地址或者端口号在报文的数据中传送，若只对报文头的 IP 地址和端口号做转换，这样就会出现不一致性，服务会终端。所以，针对这些服务，需要编写相应的模块来转换报文数据中的 IP 地址或者端口号。

VS/NAT 访问过程示例

![VS/NAT 访问过程](http://ov2iiuul1.bkt.clouddn.com/vs-nat-example.jpg)

VS/NAT 的配置如下表所示，所有到  IP 地址为 202.103.106.5 和端口为 80 的流量都被负载均衡地调度到真实服务器 172.16.0.2:80 和 172.16.0.3:8080 上。目标地址为 202.103.106.5:21 的报文被转移到 172.16.0.3:21 上。而到其他端口的报文将被拒绝。

| Protocol | Virtual IP Address | Port | Real IP Address | Port | Weight |
| -------- | ------------------ | ---- | --------------- | ---- | ------ |
| TCP      | 202.103.106.5      | 80   | 172.16.0.2      | 80   | 1      |
| TCP      | 202.103.106.5      | 80   | 172.16.0.3      | 8000 | 2      |
| TCP      | 202.103.106.5      | 21   | 172.16.0.3      | 21   | 1      |

报文改写流程

访问 WEB 服务的报文可能有一下的原地址和目标地址

| SOURCE:PORT      | DEST:PORT        |
| ---------------- | ---------------- |
| 202.100.1.2:3456 | 202.103.106.5:80 |

调度器从调度列表中选出一台服务器，例如是 172.16.0.3:8000。该报文会被改写成为如下地址，并将它发送给选出的服务器

| SOURCE:PORT      | DEST:PORT       |
| ---------------- | --------------- |
| 202.100.1.2:3456 | 172.16.0.3:8000 |

从服务器返回到调度器的响应报文如下

| SOURCE:PORT     | DEST:PORT        |
| --------------- | ---------------- |
| 172.16.0.3:8000 | 202.100.1.2:3456 |

响应报文的源地址会被改为虚拟服务器的地址，再将报文发送给客户端

| SOURCE:PORT      | DEST:PORT        |
| ---------------- | ---------------- |
| 202.103.106.5:80 | 202.100.1.2:3456 |

这样，客户端认为是从 202.103.106.5:80 服务得到的正确响应，而不会知道该请求是后端的真实服务器处理的 。



**通过 IP 隧道实现虚拟服务器（VS/TUN）**

在 VS/NAT 的集群系统中，请求和响应的数据报文都需要通过负载调度器，当真实服务器的数目在 10 和 20 台之间时，负载调度器将称为整合集群系统的新瓶颈。大多数 Internet 服务都有这样的特点；请求报文较短而响应报文往往包含大量的数据。如果能将请求和响应分开处理，即在负载调度器中只负责调度请求而响应直接返回给客户端，将极大地提高整合集群系统的吞吐量。

IP 隧道（IP tunneling）是一个将 IP 报文封装在另一个 IP 报文的技术，这可以使得目标为一个 IP 地址的数据报文能被封装和转发到另一个 IP 地址。IP 隧道技术亦称为 IP 封装技术（IP encapsulation）。IP 隧道主要用于移动主机和虚拟私有网络（Virtual Private Network），在其中隧道都是静态建立的，隧道的一端有一个 IP 地址，另一段也有唯一的 IP 地址。

利用 IP 隧道技术将请求报文封装转发给后端服务器，响应报文能从后端服务器直接返回给客户端。但在这里，后端服务器有一组而非一个，所以不可能静态的建立一一对应的隧道，而是动态地选择一台服务器，将请求报文封装和转发给选出的服务器。这样，就可以利用 IP 隧道的原理将一组服务器上的网络服务组成一个 IP 地址上的虚拟网络服务。VS/TUN 的结构如下图所示，各个服务器将 VIP 地址配置在自己的 IP 隧道设备上。

![VS/TUN](http://ov2iiuul1.bkt.clouddn.com/vs-tun.jpg)



VS/TUN 的工作流程如下图所示：它的连接调度和管理与 VS/NAT 中的一样，只是他的报文转发方法不同。调度器根据各个服务器的负载情况，动态地选择一台服务器，将请求报文封装在另一个 IP 报文中，再将封装后的 IP 报文转发给选出的服务器；服务器收到报文后，先将报文解封获得原来目标地址为 VIP 的报文，服务器发现 VIP 地址被配置在本地的 IP 隧道设备上，所以就处理这个请求，然后根据路由表将响应报文直接返回给客户端。

![VS/TUN 工作流程](http://ov2iiuul1.bkt.clouddn.com/vs-tun-flow.jpg)



在这里需要指出，根据缺省的 TCP/IP 协议栈处理，请求报文的目标地址为 VIP，响应报文的源地址肯定也为 VIP，所以响应报文不需要做任何修改，可以直接返回给客户端，客户端认为得到的是正常的服务，而不会知道究竟是哪一台服务器处理的。

半连接的 TCP 有限状态机

![tcp/ip](http://ov2iiuul1.bkt.clouddn.com/half-stm.jpg)

**通过直接路由实现虚拟服务器（VS/DR）**

与 VS/TUN 方法相同，VS/DR 利用大多数 Internet 服务的非对称特点，负载调度器中只负责调度请求，而后端真实服务器直接将响应返回给客户端，可以极大地提高整个集群系统的吞吐量。

VS/DR 的体系结构如下图所示：调度器和后端真实服务器组都必须在物理上有一个网卡通过不分断的局域网相连，如通过高速的交换机相连。VIP 地址为调度器和真实服务器组共享，调度器配置的 VIP 地址是对外可见的，用于接收虚拟服务的请求报文，后端所有的真实服务器把 VIP 地址配置在各自的 Non-ARP 网络设备上，它对外面是不可见的，只是用于处理目标地址为 VIP 的网络请求

![VS/DR](http://ov2iiuul1.bkt.clouddn.com/vs-dr.jpg)

VS/DR 的工作流程如下图所示：它的连接调度和管理与 VS/NAT 和 VS/TUN 中的一样，它的报文转发方法又有不同，将报文直接路由给目标服务器。在 VS/DR 中，调度器根据各个服务器负载情况，动态地选择一台服务器，不修改也不封装 IP 报文，而是将数据帧的 MAC 地址改为选出的真实服务器的 MAC 地址，再将修改后的数据帧发送到与后端真实服务器同在的局域网中。因为数据帧的 MAC 地址是选出的后端真实服务器，所以后端真实服务器肯定可以收到这个数据帧，从中可以取得该 IP 报文。当服务器发现报文的目标地址 VIP 是在本地的网络设备上，服务器处理就处理这个报文，然后根据路由表将响应报文直接返回给客户端。

 ![VS/DR 数据发送过程](http://ov2iiuul1.bkt.clouddn.com/vs-dr-flow.jpg)

在 VS/DR 中，根据确实的 TCP/IP 协议栈处理，请求报文的目标地址为 VIP，响应报文的源地址肯定也为 VIP，所以响应报文不需要做任何修改，可以直接返回给客户端，客户端认为得到的是正常的服务，而不会知道是哪一台服务器处理的。

VS/DR 负载调度器跟 VS/TUN 一样只处于从客户端到服务器的半连接中，安装半连接的 TCP 有限状态机进行状态迁移。



**三种方法的优缺点比较**

三种 IP 负载均衡技术的优缺点归纳

|       /        | VS/NAT        | VS/TUN     | VS/DR         |
| :------------: | ------------- | ---------- | ------------- |
|  Real Server   | any           | Tunneling  | Non-ar device |
| Server Network | private       | LAN/WAN    | LAN           |
| Server Number  | low(10~20)    | Hight(100) | Hight(100)    |
| Server Gateway | load balancer | own router | own router    |

以上三种方法所能支持的最大服务器数目的估计是假设调度器使用 100M 网卡，调度器的硬件配置域后端真实服务器的硬件配置相同，而且是对一般 web 服务。使用更改的硬件配置（如千兆网卡和更快的处理器）作为调度器，调度器所能调度的服务器数量会相应增加。当应用不同时，服务器的数目也会相应的变化。所以，以上数据估计主要是为三种方法的伸缩性进行量化比较。

**Virtual  Server via NAT**

VS/NAT 的优点是服务器可以运行任何支持 TCP/IP 的操作系统，它只需要一个 IP 地址配置在调度器上，服务器组可以用私有的 IP 地址。缺点是它的伸缩能力有限，当服务器节点数目升到 20 时，调度器本身有可能成为系统的新瓶颈，因为在 VS/NAT 中请求和响应报文都需要通过负载调度器。

基于 VS/NAT 的集群系统可以适合许多服务器的性能要求。如果负载调度器成为新的瓶颈，可以有三种方法解决这个问题：混合方法、VS/TUN 和 VS/DR。在  DNS 混合集群系统中，有若干个 VS/NAT 负载调度器，每个负载调度器带自己的服务器集群，同时这些负载调度器又通过 RR-DNS 组成简单的域名。但 VS/TUN 和 VS/DR 是提高系统吞吐量的更好方法。

对于那些将 IP 地址或者端口号在报文数据中传送的网络服务，需要编写相应的应用模块来转换报文数据中的 IP 地址或者端口号。这会带来实现的工作量，同时应用模块检查报文的开销会降低系统的吞吐量 。

**Virtual Server via IP Tunneling**

在 VS/TUN 的集群系统中，负载调度器只将请求调度到不同的后端服务器，后端服务器将应答报文直接返回给客户。这样，负载调度器只有 100Mbps 的全双工网卡，整合系统的最大吞吐量可超过 1Gbps。所以，VS/TUN 可以极大地增加负载调度器调度的服务器数量。VS/TUN 调度器可以调度上摆台服务器，而它本身不会成为系统的瓶颈，可以用来构建高性能的超级服务器。

VS/TUN 技术对服务器有要求，即所有的服务器必须支持“IP Tunneling” 或者 “IP encapsulation” 协议。

**Virtual Server via Direct Routing**

跟 VS/TUN 方法一样，VS/DR 调度器只处理客户端到服务器端的连接，响应数据可以直接从独立网络路由返回给客户端。这可以极大地提高 LVS 集群系统的伸缩性。

跟 VS/TUN 相比，这种方法没有 IP 隧道的开销，但是要求负载调度器与实际服务器都有一块网卡连载同一物理网段上，服务器网络设备（或者设备别名）不做 ARP 响应，或者能将报文重定向（Redirect）到本地的 Socket 端口上。



摘抄自 章文嵩博士《Linux服务器集群系统(三)》 原文链接：http://www.linuxvirtualserver.org/zh/lvs3.html



END!